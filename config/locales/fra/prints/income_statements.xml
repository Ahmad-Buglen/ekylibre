<?xml version="1.0"?>
<template title="Example" orientation="portrait" format="210x297" unit="mm" query-standard="sql" size="10">
  <title query="select current_user">The Book of #{title.current_user}</title>
  <infos>
    <info type="created-on">04/09/2008</info>
  </infos>
  <loop name="loop0">
    <block type="footer" height="17">
      <line x1="10" y1="0" x2="200" y2="0" border-color="#000" />
      <text x="10" y="2" width="100" height="5" align="L" size="7"> {CURRENT_TIMESTAMP:%e %B %Y à %H %M } </text>
      <text x="10" y="5" width="100" height="5" align="L" size="7"> Compte de Résultat </text>
      <text x="10" y="8" width="100" height="5" align="L" size="7"> Exercice du {LOCAL:from} au {LOCAL:to} </text>
      <text x="180" y="3" width="30" height="5" align="L">Page {PAGENO}/{PAGENB}</text>
      <text x="90" y="2" width="20" height="5" align="C">   {LOCAL:company_name}  </text>
      <text x="90" y="6" width="20" height="5" align="C" size="7"> SIREN : {LOCAL:siren} </text>
    </block>
    <block name="company">
      <text x="10" y="10" width="100" height="15" align="L" size="15"> {LOCAL:company_name} </text>
      <text x="10" y="15" width="50" height="15" align="L" size="10">  SIREN : {LOCAL:siren} </text>
      <text x="65" y="25" width="70" height="15" align="C" size="15"> Compte de Résultat </text>
      <text x="65" y="35" width="70" height="15" align="C" size="15" weight="bold"> Exercice {LOCAL:name} du {LOCAL:from} au {LOCAL:to} </text>
      <text x="65" y="50" width="200" height="10" align="C" >    </text>
    </block>
    <block type="header" height="7"/>
    <loop name="account" query="SELECT id , number , name FROM accounts WHERE accounts.number LIKE '6%' OR accounts.number LIKE '7%' ORDER BY number">
      <loop name="subsum" query="SELECT debit , credit , count,  solde, 1 FROM (SELECT sum(entries.debit) as debit , sum(entries.credit) as credit, count(entries.id) AS count, (sum(entries.credit) - sum(entries.debit)) as solde FROM entries JOIN journal_records ON (entries.record_id=journal_records.id) WHERE entries.company_id = {LOCAL:current_company} AND account_id = #{account.id}  AND created_on BETWEEN '{LOCAL:from}' AND '{LOCAL:to}') as subsum "/>
      <block name="space" if="#{subsum.count}>0" >
	<text x="10" y="0" width="50" height="5" align="L" border_width="0.2">#{account.name}</text>
	<text x="60" y="0" width="20" height="5" align="L" border_width="0.2">#{account.number}</text>
	<text x="80" y="0" width="37.5" height="5" align="L" borderwidth="0.2"> Solde #{subsum.solde}</text>
	<text x="117.5" y="0" width="27.5" height="5" align="C" border-width="0.2">Totaux</text>
	<text x="145" y="0" width="27.5" height="5" align="R" border-width="0.2">#{subsum.debit}</text>
	<text x="172.5" y="0" width="27.5" height="5" align="R" border-width="0.2">#{subsum.credit}</text>
      </block>
    </loop>
  </loop>
</template>
