<?xml version="1.0" encoding="UTF-8"?>
<aggregators xmlns="http://www.ekylibre.org/XML/2013/aggregators">
  <aggregator name="activity_cost" version="0.0" category="management">
    <parameters>
      <parameter name="campaigns" type="record-list" of="campaign" default="currents"/>
    </parameters>
    <section name="campaigns">
      <variable name="company" value="Entity.of_company"/>
      <property name="entity_name" value="company.full_name"/>
      <property name="address" value="company.default_mail_address.coordinate"/>
      <sections for="campaign" in="campaigns">
        <property name="id" of="campaign" level="api"/>
        <title name="name" of="campaign"/>
        <!-- looking for all activity in current campaign -->
        <sections for="activity" in="Activity.of_campaign(campaign).where(nature: :main)" of-type="record">
          <title name="name" of="activity"/>
          <property name="family" of="activity"/>
          <property name="shape_area" value="activity.shape_area(campaign).in_square_meter.convert(:hectare).round(2)" type="measure"/>
          <property name="shape_area_in_hectare" value="activity.shape_area(campaign).in_square_meter.convert(:hectare).round(2).value" type="measure" level="api"/>
          <property name="id" of="activity" level="api"/>
          <property name="intervention_durations" value="activity.interventions_duration(campaign).in_second.convert(:hour).round(2)" type="measure" />
          
          <!-- looking for all Interventions in current campaign and activity -->
          <matrix name="interventions" for="intervention" in="Intervention.of_activities(activity).of_campaign(campaign).order(:started_at)">             
            <cell name="id" of="intervention" level="api"/>
            <cell name="name" of="intervention" of-type="record"/>
            <cell name="production_support" value="intervention.production_support.storage.name" of-type="record"/>
            <cell name="started_at" of="intervention" type="datetime"/>
            <cell name="duration" value="intervention.duration.in_second.convert(:hour).round(2)" type="number"/>
            <cell name="input_cost" value="intervention.cost(:input)" type="money"/>
            <cell name="equipment_cost" value="intervention.cost(:equipment)" type="money"/>
          </matrix>          
        </sections>
      </sections>
    </section>
  </aggregator>
</aggregators>