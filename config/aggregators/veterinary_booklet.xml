<?xml version="1.0" encoding="UTF-8"?>
<aggregators xmlns="http://www.ekylibre.org/XML/2013/aggregators">
  <aggregator name="veterinary_booklet" version="0.0">
    <parameters>
      <parameter name="campaigns" type="record-list" of="campaign" default="currents"/>
      <parameter name="company" type="record" of="entity" default="of_company"/>
      <parameter name="breeding_number" type="string" default="XXXXXXXX"/>
    </parameters>
    <section name="interventions">
      <property name="campaign" value="campaigns.pluck(:name).to_sentence"/>
      <property name="entity_name" value="company.full_name"/>
      <property name="address" value="company.default_mail_address.coordinate"/>
      <property name="breeding_number"/>
      <sections for="intervention" in="Procedure.of_nature(:animal_care)">
	<variable name="target" value="intervention.variables.of_role(:target).first.target"/>
	<variable name="worker" value="intervention.variables.of_role(:worker).first.target"/>
	<title name="name" of="intervention"/>
	<property name="id" of="intervention" level="api"/>
	<property name="started_at" of="intervention"/>
	<property name="stopped_at" of="intervention"/>
	<property name="duration" value="((intervention.stopped_at - intervention.started_at).to_d/(60*60*24)).round(2)"/>
	<matrix name="inputs" for="input" in="intervention.variables.of_role(:input)">
          <variable name="meat_withdrawal_period" value="input.target.meat_withdrawal_period.to_f"/>
          <variable name="milk_withdrawal_period" value="input.target.milk_withdrawal_period.to_f"/>
	  <cell name="id" of="input" level="api"/>
	  <within name="target">
	    <cell name="identification_number"/>
	    <cell name="name"/>
	    <cell name="id" level="api"/>
	    <cell name="type" level="api"/>
	  </within>
	  <within name="worker">
	    <cell name="identification_number"/>
	    <cell name="name"/>
	    <cell name="id" level="api"/>
	    <cell name="person_id" level="api"/>
	  </within>
	  <within of="input.target">
	    <cell name="name"/>
	    <cell name="nature_name"/>
	    <cell name="variety" level="api"/>
	  </within>
	  <cell name="measure_quantity" of="input"/>
	  <cell name="measure_unit" of="input"/>
	  <matrix name="withdrawal_periods">
	    <cell name="meat_withdrawal_period" value="meat_withdrawal_period"/>
	    <cell name="milk_withdrawal_period" value="milk_withdrawal_period"/>
	  </matrix>
	  <matrix name="sale_dates">
	    <cell name="meat_saleable_on" value="(intervention.stopped_at + meat_withdrawal_period).to_date"/>
	    <cell name="milk_saleable_on" value="(intervention.stopped_at + milk_withdrawal_period).to_date"/>
	  </matrix>
	  <within name="incident" of="intervention.incident">
	    <cell name="id" level="api"/>
	    <cell name="name"/>
	    <cell name="observed_at"/>
	    <cell name="state" level="api"/>
	    <cell name="description"/>
	  </within>	
	  <within name="prescription" of="intervention.prescription">
	    <cell name="id" level="api"/>
	    <cell name="reference_number"/>
	    <cell name="prescriptor_name"/>
	  </within>	
	</matrix>
      </sections>
    </section>
  </aggregator>
</aggregators>