<?xml version="1.0"?>
<template title="Balance" orientation="portrait" format="210x297" unit="mm" query-standard="sql" size="10">
  <title query="select current_user">Balance du {LOCAL:from} au {LOCAL:to}</title>
  <infos>
    <info type="created-on">04/09/2008</info>
  </infos>
  <loop name="loop0">
    <block type="footer">
      <line x1="10" y1="0" x2="200" y2="0" border-color="#000" />
      <text x="10" y="2" width="100" height="5" align="L" size="7"> {CURRENT_TIMESTAMP:%e %B %Y à %H %M } </text>
      <text x="10" y="5" width="100" height="5" align="L" size="7"> Balance </text>
      <text x="10" y="8" width="100" height="5" align="L" size="7"> Période du {LOCAL:from} au {LOCAL:to} </text>
      <text x="180" y="3" width="30" height="5" align="L">Page {PAGENO}/{PAGENB}</text>
      <text x="90" y="2" width="20" height="5" align="C">   {LOCAL:company_name}  </text>
      <text x="90" y="6" width="20" height="5" align="C" size="7"> SIREN : {LOCAL:siren} </text>
    </block>
    <block name="company">
      <text x="10" y="10" width="100" height="15" align="L" size="15"> {LOCAL:company_name} </text>
      <text x="10" y="15" width="50" height="15" align="L" size="10">  SIREN : {LOCAL:siren} </text>
      <text x="65" y="25" width="70" height="15" align="C" size="15"> Balance </text>
      <text x="65" y="35" width="70" height="15" align="C" size="15" weight="bold"> Période du {LOCAL:from} au {LOCAL:to} </text>
      <text x="65" y="50" width="200" height="10" align="C" >    </text>
    </block>
    <block type="header" height="7"/>
    <block name="menu">
      <text x="10" y="0" width="146" height="7" align="C" border-width="0.2" background-color="#CCC" color="#000" weight="bold">Compte</text>
      <text x="156" y="0" width="44" height="7" align="C" border-width="0.2" background-color="#CCC" color="#000" weight="bold" >Solde</text>
      <text x="10" y="7" width="25" height="7" align="C" border-width="0.2" background-color="#CCC" color="#000" weight="bold">Numero</text>
      <text x="35" y="7" width="121" height="7" align="C" border-width="0.2" border-align="C" background-color="#CCC" color="#000" weight="bold" >Intitule</text>
      <text x="156" y="7" width="22" height="7" align="C" border-width="0.2" background-color="#CCC" color="#000" weight="bold">Debit</text>
      <text x="178" y="7" width="22" height="7" align="C" border-width="0.2" background-color="#CCC" color="#000" weight="bold" >Credit</text>
    </block>
    <loop name="balance" query="SELECT number , name , local_credit , local_debit, solde FROM accounts LEFT JOIN (SELECT account_id, coalesce(sum(entries.credit),0) as local_credit, coalesce(sum(entries.debit),0) as local_debit, coalesce(sum(entries.credit),0) - coalesce(sum(entries.debit),0) as solde FROM entries INNER JOIN journal_records ON entries.record_id = journal_records.id  WHERE journal_records.created_on BETWEEN CAST('{LOCAL:from}' AS date) AND CAST('{LOCAL:to}' AS date) GROUP BY account_id) as balance ON accounts.id = account_id ORDER BY number">
      <block name="test">
	<text x="10" y="0" width="25" height="5" align="L" border-width="0.2">#{balance.number}</text>
	<text x="35" y="0" width="121" height="5" align="L" border-width="0.2">#{balance.name}</text>
	<text x="156" y="0" width="22" height="5" align="R" border-width="0.2" if="CAST(COALESCE(NULLIF(#{balance.local_debit},''),'0') AS numeric) > 0">#{balance.local_debit}</text>
	<text x="156" y="0" width="22" height="5" align="R" border-width="0.2" if="CAST(COALESCE(NULLIF(#{balance.local_debit},''),'0') AS numeric) = 0">   </text>
	<text x="178" y="0" width="22" height="5" align="R" border-width="0.2" if="CAST(COALESCE(NULLIF(#{balance.local_credit},''),'0') AS numeric) = 0" >  </text>
	<text x="178" y="0" width="22" height="5" align="R" border-width="0.2" if="CAST(COALESCE(NULLIF(#{balance.local_credit},''),'0') AS numeric) > 0" >#{balance.local_credit}</text>
	<!--<text x="182.5" y="0" width="27.5" height="5" align="R" border-width="0.2" if="#{balance.local_debit}::numeric = 0">  </text>-->
      </block>
    </loop>
    <loop name="sum" query="SELECT sum_credit , sum_debit, 1 FROM(SELECT sum(local_credit) as sum_credit , sum(local_debit) as sum_debit , 1 FROM accounts LEFT JOIN (SELECT account_id, coalesce(sum(entries.credit),0) as local_credit, coalesce(sum(entries.debit),0) as local_debit, coalesce(sum(entries.credit),0) - coalesce(sum(entries.debit),0) as solde FROM entries INNER JOIN journal_records ON entries.record_id = journal_records.id  WHERE journal_records.created_on BETWEEN CAST('{LOCAL:from}' AS date) AND CAST('{LOCAL:to}' AS date) GROUP BY account_id) as balance ON accounts.id = account_id) as sum">
    </loop>
    <block name="solde">
      <text x="131" y="0" width="25" height="5" align="C" border-width="0.2" weight="bold">Totaux</text>
      <text x="156" y="0" width="22" height="5" align="R" border-width="0.2">#{sum.sum_debit}</text>
      <text x="178" y="0" width="22" height="5" align="R" border-width="0.2">#{sum.sum_credit}</text>
    </block>
  </loop>
</template>

