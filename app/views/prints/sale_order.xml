<?xml version="1.0"?>
<template title="Order Sale" orientation="portrait" format="210x297" unit="mm" query-standard="sql" size="8">
  <title query="select current_user">Devis #{title.current_user}</title>
  <infos>
    <info type="created-on">04/09/2008</info>
  </infos>
  <loop name="loop0">
    <loop name="sale" query="SELECT number , state ,1  FROM sale_orders WHERE id = {KEY}">
    </loop>
    <block type="footer" height="17">
      <line x1="10" y1="0" x2="200" y2="0" border-color="#000" />
      <text x="10" y="2" width="100" height="3" align="L"> Devis n° #{order.number} </text>
      <text x="10" y="5" width="100" height="3" align="L" size="7"> Page {PAGENO}/{PAGENB} </text>
      <text x="165" y="3" width="15" height="5" align="L" size="7"> Paraphe   </text>
      <text x="180" y="2" width="17" height="7" align="L" border-width="0.2">  </text>
      <text x="90" y="2" width="30" height="5" align="C" size="7"> {CURRENT_TIMESTAMP:%e %B %Y } </text>
      <text x="90" y="6" width="30" height="5" align="C" size="7"> infos company </text>
    </block>
    <loop name="company" query="SELECT name, code ,siren FROM companies INNER JOIN sale_orders ON sale_orders.company_id = companies.id WHERE sale_orders.id={KEY} ">
      <loop name="client" query="SELECT id,  full_name , code , nature , 1 FROM(SELECT entities.id as id, entities.full_name as full_name ,code , entity_natures.name as nature FROM entities INNER JOIN entity_natures ON entities.nature_id = entity_natures.id WHERE entities.id IN (SELECT client_id FROM sale_orders WHERE id = {KEY}))as client">
      </loop>
      <loop name="address" query="SELECT line_2,line_3,line_4_number,line_4_street,line_5,line_6_code,line_6_city,1 FROM contacts INNER JOIN entities ON contacts.entity_id = #{client.id} ">
      </loop>
      <block name="company">
	<text x="10" y="20" width="90" height="10" align="L" weight="bold" size="20">#{company.name}</text>
	<text x="10" y="30" width="90" height="5" align="L" size="8">Siren: #{company.siren}</text> 
	<text x="100" y="35" width="90" height="5" align="L" size="10"> #{client.nature} #{client.full_name} </text>
      </block>
      <block name="line2" if="length(#{address.line_2})>0">
	<text x="100" y="5" width="90" height="5" align="L" size="10"> #{address.line_2} </text>
      </block>
      <block name="line3" if="length(#{address.line_3})>0">
	<text x="100" y="0" width="90" height="5" align="L" size="10"> #{address.line_3} </text>
      </block>
      <block name="line4" if="length(#{address.line_4_number})>0 OR length(#{address.line_4_street})>0">
	<text x="100" y="0" width="90" height="5" align="L" size="10"> #{address.line_4_number}#{address.line_4_street} </text>
      </block>
      <block name="line5" if="length(#{address.line_5})>0">
	<text x="100" y="0" width="90" height="5" align="L" size="10"> #{address.line_5} </text>
      </block>
      <block if="length(#{address.line_6_code})>0 OR length(#{address.line_6_city})>0">
	<text x="100" y="0" width="90" height="5" align="L" size="10"> #{address.line_6_code} #{address.line_6_city}</text>
      </block>
    </loop>
    <block name="devis">
      <text x="90" y="5" width="110" height="10" align="L" weight="bold" size="20" if="#{sale.state}='P'"> Devis </text>
      <text x="90" y="5" width="110" height="10" align="L" weight="bold" size="20" if="#{sale.state}='D'"> Facture </text>
    </block>
    <block name="infos">
      <text x="10" y="10" width="90" height="10" align="L" weight="bold">Devis n° #{sale.number} </text>
    </block>
    <block name="table">
      <text x="10" y="0" width="18" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> Code </text> 
      <text x="28" y="0" width="90" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> Désignation </text>
      <text x="118" y="0" width="13" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> Qte </text>
      <text x="131" y="0" width="5" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> U </text>
      <text x="136" y="0" width="17" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> PU HT </text>
      <text x="153" y="0" width="17" height="10" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> HT </text>
      <text x="170" y="0" width="30" height="5" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD">  T.V.A. </text>
      <text x="170" y="5" width="17" height="5" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> Montant </text>
      <text x="187" y="5" width="13" height="5" align="C" border-width="0.2" color="#000" weight="bold" background-color="#DDD"> Taux </text>
    </block>
    <loop name="products" query="SELECT name , id , code, montant_ht,montant_tva , quantity,unit_id, 1 FROM(SELECT products.id as id , products.name as name , products.code as code , products.unit_id as unit_id, sale_order_lines.amount as montant_ht , (sale_order_lines.amount_with_taxes - sale_order_lines.amount) as montant_tva ,quantity FROM sale_order_lines INNER JOIN products ON products.id = sale_order_lines.product_id WHERE order_id = {KEY})as products">
      <loop name="prices" query="SELECT amount,tax_id,1 FROM(SELECT round(prices.amount,2) as amount , tax_id FROM prices INNER JOIN products ON prices.product_id = #{products.id}) as prices">
	<loop name="taxes" query="SELECT tax_amount,nature, 1 FROM(SELECT round((taxes.amount*100),2) as tax_amount, nature FROM taxes INNER JOIN prices ON taxes.id = #{prices.tax_id}) as taxes">
	</loop>
      </loop>
      <loop name="unit" query="SELECT name FROM units WHERE  id = #{products.unit_id}">
      </loop>
      <block name="lines">
	<text x="10" y="0" width="18" height="4" align="C" border-width="0.2" color="#000">#{products.code}</text>
	<text x="28" y="0" width="90" height="4" align="L" border-width="0.2" color="#000">#{products.name}</text>
	<text x="118" y="0" width="13" height="4" align="R" border-width="0.2" color="#000">#{products.quantity}</text>
	<text x="131" y="0" width="5" height="4" align="R" border-width="0.2" color="#000">#{unit.name}</text>
	<text x="136" y="0" width="17" height="4" align="R" border-width="0.2" color="#000">#{prices.amount}</text> 
	<text x="153" y="0" width="17" height="4" align="R" border-width="0.2" color="#000">#{products.montant_ht}</text>
	<text x="170" y="0" width="17" height="4" align="R" border-width="0.2" color="#000">#{products.montant_tva}</text>
	<text x="187" y="0" width="13" height="4" align="R" border-width="0.2" color="#000" if="#{taxes.nature}='percent'">#{taxes.tax_amount}%</text>
      </block>
    </loop> 
    <loop name="sums" query="SELECT montant_ht, montant_ttc,montant_taxes,1 FROM(SELECT sum(amount) as montant_ht ,sum(amount_with_taxes) as montant_ttc ,(sum(amount_with_taxes) - sum(amount)) as montant_taxes FROM sale_order_lines WHERE order_id = {KEY}) as sums">
    </loop>
    <block name="sum">
      <text x="118" y="0" width="35" height="5" align="L" border-width="0.2" weight="bold" background-color="#DDD"> Totaux  </text>
      <text x="118" y="5" width="35" height="8" align="L" border-width="0.2" weight="bold" size="10" background-color="#DDD"> Net à payer </text>
      <text x="153" y="5" width="34" height="8" align="C" border-width="0.2" weight="bold" size="10">#{sums.montant_ttc}</text>
      <text x="153" y="0" width="17" height="5" align="R" border-width="0.2">#{sums.montant_ht}</text>
      <text x="170" y="0" width="17" height="5" align="R" border-width="0.2">#{sums.montant_taxes}</text>
    </block>
    <block name="sign_up"> 
      <!-- <text x="10" y="15" width="70" height="5" align="L" weight="bold"> Mode de paiement : </text>
	   <text x="10" y="25" width="70" height="5" align="L" weight="bold"> Conditions générales : </text>-->
      <text x="10" y="42" width="70" height="5" align="L" weight="bold">      Dans la case ci-contre, veuillez dater, porter la </text>
      <text x="10" y="47" width="70" height="5" align="L" weight="bold"> mention "Bon pour accord" et apposer votre signature.</text>
      <rectangle x="90" y="40" width="110" height="15" radius="5" border-color="#000" border-width="0.2"/>
    </block>
    <block type="header" height="7"/>
  </loop>
</template>
