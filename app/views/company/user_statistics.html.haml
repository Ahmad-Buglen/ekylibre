.search 
  =form_tag do
    %table
      %tr
        %td.crit
          %span=tc(:manual_period, :start=>calendar_field_tag(:started_on, params[:started_on], :size=>8), :finish=>calendar_field_tag(:stopped_on, params[:stopped_on], :size=>8)).html_safe
        %td=submit_tag tg(:search_go)


-conditions = Proc.new{|x| ["#{x} BETWEEN ? AND ?", params[:started_on], params[:stopped_on]]}
=unagi do |u|
  -u.cell :x_sales, :count=>@current_user.sales.count(:id, :conditions=>conditions[:created_on]) do
    %table.kame
      %tr.total
        %th=tc(:total_amount)
        %td=number_to_management @current_user.sales.sum(:amount, :conditions=>conditions[:created_on])
      %tr.total
        %th=tc(:total_invoiced_amount)
        %td=number_to_management(invoiced_amount = @current_user.sales_invoices.sum(:amount, :conditions=>conditions[:invoiced_on]))
      %tr.total
        %th=tc(:total_paid_amount)
        %td=number_to_management(paid_amount = @current_user.sales.sum(:paid_amount, :conditions=>conditions[:created_on]))
      %tr.total
        %th=tc(:total_unpaid_amount)
        %td=number_to_management (invoiced_amount - @current_user.sales_invoices.sum(:paid_amount, :conditions=>conditions[:invoiced_on]))
      %tr.total
        %th=tc(:profitability)
        %td=number_to_percentage 100*(paid_amount/invoiced_amount)
  -started_at, stopped_at = params[:started_on].beginning_of_day, params[:stopped_on].end_of_day
  -cond = ["created_at BETWEEN ? AND ?", started_at, stopped_at]
  -u.cell :x_events, :count=>@current_user.events.count(:id, :conditions=>cond) do
    %ul
      -for event_nature in @current_company.event_natures
        -cond = ["nature_id=? AND created_at BETWEEN ? AND ?", event_nature.id, started_at, stopped_at]
        %li=h tc(:x_events_of_nature_y, :count=>@current_user.events.count(:id, :conditions=>cond).to_i, :nature=>event_nature.name, :duration=>@current_user.events.sum(:duration, :conditions=>cond).to_i)
