- item ||= f.object
%tbody.nested-fields.purchase-invoice-items{ data: { trade_item: "purchase", iceberg: true } }
  %tr.item-display.hidden
    %td.act
      - if f.object.destroyable?
        = link_to_remove_association(content_tag(:i) + h(:destroy.tl), f, 'data-no-turbolink' => true, class: 'destroy remove remove-item')
    %td.act
      = link_to("#", class: 'edit edit-item', data: { edit: "item-form" }) do
        %i
        = :edit.tl
    %td.product-column
      %label{ data: { item_value: "input.invoice-variant" } }= f.object.variant ? f.object.variant.name : '??????'
    %td.quantity-column
      %label{ data: { item_value: "input.invoice-quantity" } }= f.object.variant ? f.object.variant.name : '??????'
    %td.unit-amount-column.two-rows-column
      %label{ data: { item_value: "input.invoice-unit-amount" } }= f.object.variant ? f.object.variant.name : '??????'
      %label{class: "invoice-second-row-label"}= :discount_without_percent.tl
      %label{ data: { item_value: "input.invoice-discount-percentage" } }= f.object.variant ? f.object.variant.name : '??????'
    %td.total-column.two-rows-column
      %label{ class: 'amount-excluding-taxes', data: { item_value: "input.invoice-total" } }= f.object.variant ? f.object.variant.name : '??????'
      %label{ class: "invoice-second-row-label"}= :vat_rate.tl
      %label{ class: 'vat-rate', data: { item_value: "select.invoice-vat-total option:selected" } }= f.object.variant ? f.object.variant.name : '??????'

  %tr.nested-item-form
    %td.form-field.merchandise
      = f.referenced_association(:variant, label: :merchandise.tl, source: {scope: :purchaseables}, input_html: {class: "invoice-variant", data: {variant_of_deal_item: {url: detail_backend_product_nature_variant_path("RECORD_ID", mode: :last_purchase_item)}}})
    %td.form-field.decimal= f.input(:quantity, input_html: {class: "invoice-quantity", size: 7, data: {trade_component: "quantity"}})
    %td.form-field= f.input(:unit_pretax_amount, label: :unit_amount.tl, input_html: {class: "invoice-unit-amount", data: {trade_component: "unit_pretax_amount"}})    
    %td.form-field= f.input(:reduction_percentage, label: :discount_without_percent.tl, input_html: {class: "invoice-discount-percentage", data: {trade_component: "reduction_percentage"}})
    %td.form-field.decimal= f.input(:pretax_amount, input_html: {class: "pta invoice-total", data: {trade_component: "pretax_amount"}})
    %td.form-field.decimal= f.input(:tax_id, label: :vat_rate.tl, collection: Tax.current.collect{|t| [t.short_label, t.id, {'data-rate' => ((100 + t.usable_amount)/100)}]}, selected: 1, input_html: { class: "invoice-vat-total", data: {value: 'rate', trade_component: "tax"}})
    -#%td.action= link_to_remove_association(content_tag(:i) + h(:destroy.ta), f, 'data-no-turbolink' => true, class: 'remove-item')

    %td.form-field.third-row
      .item-form
        - if Preference[:distribute_sales_and_purchases_on_activities] && current_user.can?(:read, :activities) && ActivityBudget.opened.any?
          = f.referenced_association(:activity_budget, new: false)
        - if Preference[:distribute_sales_and_purchases_on_teams] && current_user.can?(:read, :teams)
          = f.referenced_association(:team)

    %td.buttons
      %button.btn{ data: { cancel: 'item-form' } }= :cancel.tl
      %button.btn.btn-primary{ data: { validate: 'item-form' } }= :validate.tl
